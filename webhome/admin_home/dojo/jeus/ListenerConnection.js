/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["jeus.ListenerConnection"]){dojo._hasResource["jeus.ListenerConnection"]=true;dojo.provide("jeus.ListenerConnection");dojo.require("dojo.parser");dojo.require("dijit._Widget");dojo.require("dojox.gfx");dojo.require("dojox.jsonPath.query");(function(){var _1=function(_2){if(_2 instanceof dojox.gfx.Group){return _2.children[0].getBoundingBox();}else{return _2.getBoundingBox();}};var _3=function(_4,_5){var t=_4.createText(_5);t.setFont({family:"Dotum",size:"12px",weight:"normal"});t.setFill("black");return t;};var _6=dojo.declare(null,{type:"",name:"",color:[0,0,0,1],paint:function(_7,_8){}});var _9=dojo.declare(_6,{containers:[],type:"node",color:[200,100,200,1],constructor:function(_a){this.name=_a.name;this.containers=dojo.map(_a.container,function(_b,_c){return new _d(_b);});},paint:function(_e,_f){var _10=_e.createGroup();var _11=_10.createRect({width:240}).setFill(this.color);var _12=_3(_10,{text:this.name});var _13={x:10,y:20};dojo.forEach(this.containers,function(_14,_15){var _16=_14.paint(_10,_f);var _17=_1(_16);_16.setTransform([{dx:_13.x,dy:_13.y}]);_13.y+=_17.height+10;});_11.setShape({height:_13.y});return _10;}});var _d=dojo.declare(_6,{engines:[],type:"container",color:[200,200,100,1],constructor:function(_18){this.name=_18.name;this.engines=dojo.map(_18.engine,function(_19,_1a){return new _1b(_19);});},paint:function(_1c,_1d){var _1e=_1c.createGroup();var _1f=_1e.createRect({width:220}).setFill(this.color);var _20=_3(_1e,{text:this.name});var _21={x:10,y:20};dojo.forEach(this.engines,function(_22,_23){var _24=_22.paint(_1e,_1d);var _25=_1(_24);_24.setTransform([{dx:_21.x,dy:_21.y}]);_21.y+=_25.height+10;});_1f.setShape({height:_21.y});return _1e;}});var _1b=dojo.declare(_6,{contextGroups:[],type:"engine",color:[200,200,200,1],constructor:function(_26){this.name=_26.name;this.contextGroups=dojo.map(_26.context_group,function(cg,_27){return new _28(cg);});},paint:function(_29,_2a){var _2b=_29.createGroup();var _2c=_2b.createRect({width:200}).setFill(this.color);var _2d=_3(_2b,{text:this.name});var _2e={x:10,y:20};dojo.forEach(this.contextGroups,function(cg,_2f){var _30=cg.paint(_2b,_2a);var _31=_1(_30);_30.setTransform([{dx:_2e.x,dy:_2e.y}]);_2e.y+=_31.height+10;});_2c.setShape({height:_2e.y});return _2b;}});var _28=dojo.declare(_6,{listeners:[],type:"contextGroup",color:[230,230,230,1],constructor:function(_32){this.name=_32.name;this.listeners=dojo.map(_32.listener,function(ltr,_33){var _34=null;switch(ltr.type){case _35.prototype.type:_34=new _35(ltr);break;case _36.prototype.type:_34=new _36(ltr);break;case _37.prototype.type:_34=new _37(ltr);break;case _38.prototype.type:_34=new _38(ltr);break;case _39.prototype.type:_34=new _39(ltr);break;default:}return _34;});},paint:function(_3a,_3b){var _3c=_3a.createGroup();var _3d=_3c.createRect({width:180}).setFill(this.color);var _3e=_3(_3c,{text:this.name});var _3f={x:10,y:10};dojo.forEach(this.listeners,function(_40,_41){var _42=_40.paint(_3c,_3b);var _43=_1(_42);_42.setTransform([{dx:_3f.x,dy:_3f.y}]);_3f.y+=_43.height+10;});_3d.setShape({height:_3f.y});return _3c;}});var _44=dojo.declare(_6,{port:null,address:"",constructor:function(_45){dojo.safeMixin(this,_45);},paint:function(_46,_47){var _48=_46.createGroup();var _49=_48.createRect({x:0,y:0,width:160,height:30}).setFill(this.color);var _4a=_3(_48,{x:10,y:20,text:this.name});this.paintListener(_48,_47);return _48;},paintListener:function(_4b,_4c){_4b.createRect({x:210,y:0,width:48,height:30,r:7}).setFill(this.color);_3(_4b,{x:220,y:20,text:this.port});_4b.createPath().moveTo({x:160,y:15}).lineTo({x:210,y:15}).setStroke({color:"black"});}});var _35=dojo.declare(_44,{type:"apache",color:[180,180,255,1]});var _36=dojo.declare(_44,{type:"http",color:[100,205,255,1]});var _37=dojo.declare(_44,{type:"tcp",color:[130,130,130,1]});var _38=dojo.declare(_44,{type:"tmax",color:[180,255,180,1],paintListener:function(_4d,_4e){var _4f=_4d.createRect({x:-3,y:12,width:6,height:6,r:10}).setFill(this.color);var key=this.type+":"+this.address+":"+this.port;if(!(key in _4e.listeners)){_4e.listeners[key]=[];}_4e.listeners[key].push(_4f);}});var _39=dojo.declare(_44,{type:"webtob",color:[255,200,200,1],paintListener:function(_50,_51){var _52=_50.createRect({x:-3,y:12,width:6,height:6,r:10}).setFill(this.color);var key=this.type+":"+this.address+":"+this.port;if(!(key in _51.listeners)){_51.listeners[key]=[];}_51.listeners[key].push(_52);}});var _53=dojo.declare(_6,{constructor:function(_54){this.name=_54.address+":"+_54.port;},paint:function(_55,_56){var _57=_55.createGroup();var _58=_57.createRect({x:0,y:0,width:160,height:30}).setFill(this.color);var _59=_3(_57,{x:10,y:20,text:this.name});var key=this.type+":"+this.name;_56.webservers[key]=_58;return _57;}});var _5a=dojo.declare(_53,{type:_39.prototype.type,color:_39.prototype.color});var _5b=dojo.declare(_53,{type:_38.prototype.type,color:_38.prototype.color});dojo.declare("jeus.ListenerConnection",dijit._Widget,{url:"",query:"$.node[*].container[*].engine[*].context_group[*].listener[?(@.type == 'webtob' || @.type == 'tmax')]",nodes:[],webservers:[],postMixInProperties:function(){this.inherited(arguments);dojo.xhrGet({url:this.url,handleAs:"json",sync:true,load:dojo.hitch(this,function(_5c,_5d){this.json=_5c;})});this.nodes=dojo.map(this.json.node,function(_5e,_5f){return new _9(_5e);});var _60=[];this.webservers=[];dojo.forEach(dojox.jsonPath.query(this.json,this.query),function(_61,_62){var key=_61.type+"://"+_61.address+":"+_61.port;if(key in _60){}else{var _63=null;switch(_61.type){case _38.prototype.type:_63=new _5b(_61);break;case _39.prototype.type:_63=new _5a(_61);break;default:}_60[key]=key;if(_63!=null){this.webservers.push(_63);}}},this);},postCreate:function(){var _64=dojox.gfx.createSurface(this.domNode,800,100);var _65={listeners:{},webservers:{}};var _66={x:410,y:30};dojo.forEach(this.nodes,function(_67,_68){var _69=_67.paint(_64,_65);var _6a=_1(_69);_69.setTransform([{dx:_66.x,dy:_66.y}]);_66.y+=_6a.height+10;});var _6b={x:30,y:60};dojo.forEach(this.webservers,function(_6c,_6d){var _6e=_6c.paint(_64,_65);var _6f=_1(_6e);_6e.setTransform([{dx:_6b.x,dy:_6b.y}]);_6b.y+=_6f.height+20;});this.paintLink(_64,_65);var _70={x:0,y:Math.max(_66.y,_6b.y)+30};var _71=this.paintLegend(_64);_71.setTransform([{dx:_70.x,dy:_70.y}]);_64.setDimensions(800,_70.y+50);},paintLegend:function(_72){var _73=_72.createGroup();var _74=function(_75,y){var x=0;dojo.forEach(_75,function(_76,_77){_73.createRect({x:x,y:y,width:10,height:10}).setFill(_76.prototype.color);_3(_73,{x:x+15,y:y+10,text:_76.prototype.type.toUpperCase()});x+=90;});};_74([_35,_36,_37,_38,_39],0);_74([_9,_d,_1b,_28],20);return _73;},paintLink:function(_78,_79){for(var key in _79.webservers){var _7a=_79.webservers[key];var _7b={x:0,y:999999};dojo.forEach(_7a.getTransformedBoundingBox(),function(_7c){_7b.x=Math.max(_7b.x,_7c.x);_7b.y=Math.min(_7b.y,_7c.y);});_7b.y+=15;dojo.forEach(_79.listeners[key],function(end){var _7d={x:999999,y:999999};dojo.forEach(end.getTransformedBoundingBox(),function(_7e){_7d.x=Math.min(_7d.x,_7e.x);_7d.y=Math.min(_7d.y,_7e.y);});_7d.y+=2;_78.createPath().moveTo(_7b).lineTo(_7d).setStroke({color:"black"});});}}});})();}